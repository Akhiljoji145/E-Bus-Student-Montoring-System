{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Driver Dashboard - BusTracker Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="{% static 'common_scripts.js' %}"></script>
    <script>
    function logout() {
    localStorage.removeItem('currentUserRole'); // Clear stored role
    window.location.href = '{% url "driver:logout" %}'; // Redirect to login page
    }
    </script>
</head>
<body class="bg-gradient-to-br from-green-50 to-teal-100 min-h-screen">

    <script>loadDashboardNav();</script>
    <nav class="bg-white shadow-lg">
            <div class="max-w-7xl mx-auto px-4">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center space-x-4">
                        <div class="text-2xl font-bold text-indigo-600">üöå BusTracker Pro</div>
                    </div>
                    <div class="flex space-x-4">
                        <button onclick="window.location.href='index.html'" class="px-4 py-2 text-gray-600 hover:text-indigo-600 transition-colors">Home</button>
                        <button id="logoutBtn" onclick="logout()" class="px-4 py-2 text-red-600 hover:text-red-700 transition-colors">Logout</button>
                    </div>
                </div>
        </div>
    </nav>
    <div id="driver-dashboard-section" class="section active">
        <div class="max-w-7xl mx-auto py-8 px-4">
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h1 class="text-3xl font-bold text-gray-900 mb-2">Driver Dashboard</h1>
                <p class="text-gray-600">Manage student boarding, bus communications, and campus departure validation</p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <!-- Unboarded Student Alerts -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-xl font-semibold mb-4">‚ö†Ô∏è Unboarded Student Alerts</h3>
                    <div id="unboardedStudentAlerts" class="space-y-4">
                        <!-- Alerts will be dynamically added here -->
                        <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                            <div class="flex justify-between items-start mb-2">
                                <h4 class="font-medium text-yellow-800">Student Not Boarded: Emily White</h4>
                                <span class="text-xs text-yellow-600">Stop 5 - Route B</span>
                            </div>
                            <p class="text-sm text-yellow-700">Expected to board at 8:15 AM. Not scanned.</p>
                            <p class="text-xs text-gray-600">Action: Check surroundings, contact school if necessary.</p>
                            <button onclick="markStudentBoarded('Emily White')" class="mt-2 text-xs bg-yellow-600 text-white px-3 py-1 rounded hover:bg-yellow-700">Mark Boarded (Manual)</button>
                        </div>
                        <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                            <div class="flex justify-between items-start mb-2">
                                <h4 class="font-medium text-yellow-800">Student Not Boarded: David Lee</h4>
                                <span class="text-xs text-yellow-600">Stop 2 - Route B</span>
                            </div>
                            <p class="text-sm text-yellow-700">Expected to board at 8:05 AM. No scan detected.</p>
                            <p class="text-xs text-gray-600">Action: Verify presence, or report as missing.</p>
                            <button onclick="markStudentBoarded('David Lee')" class="mt-2 text-xs bg-yellow-600 text-white px-3 py-1 rounded hover:bg-yellow-700">Mark Boarded (Manual)</button>
                        </div>
                    </div>
                </div>

                <!-- Send Message about Bus Change -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-xl font-semibold mb-4">üì¢ Send Bus Change Message</h3>
                    <form onsubmit="sendBusChangeMessage(event)" class="space-y-4">
                        <div>
                            <label for="messageAudience" class="block text-sm font-medium mb-2">Send To</label>
                            <select id="messageAudience" class="w-full p-2 border rounded-md">
                                <option value="all_parents">All Parents on My Route</option>
                                <option value="school_admin">School Administration</option>
                                <option value="specific_parent">Specific Parent (Enter Email/Phone)</option>
                            </select>
                        </div>
                        <div id="specificParentContact" class="hidden">
                            <label for="parentContact" class="block text-sm font-medium mb-2">Parent Email/Phone</label>
                            <input type="text" id="parentContact" class="w-full p-2 border rounded-md" placeholder="e.g., parent@email.com or 123-456-7890">
                        </div>
                        <div>
                            <label for="busChangeSubject" class="block text-sm font-medium mb-2">Subject</label>
                            <input type="text" id="busChangeSubject" required class="w-full p-2 border rounded-md" placeholder="e.g., Bus Delay, Route Change">
                        </div>
                        <div>
                            <label for="busChangeMessage" class="block text-sm font-medium mb-2">Message</label>
                            <textarea id="busChangeMessage" rows="4" required class="w-full p-2 border rounded-md" placeholder="e.g., Bus #7 is delayed by 15 minutes due to traffic."></textarea>
                        </div>
                        <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">
                            Send Message
                        </button>
                    </form>
                </div>

                <!-- Validate Students Before Departure -->
                <div class="bg-white rounded-lg shadow-lg p-6 col-span-1 lg:col-span-2">
                    <h3 class="text-xl font-semibold mb-4">‚úÖ Validate Students Before Campus Departure</h3>
                    <div class="mb-4">
                        <p class="text-gray-700">Current Bus: <span id="currentBusNumber" class="font-semibold">Bus #7</span></p>
                        <p class="text-gray-700">Route: <span id="currentBusRoute" class="font-semibold">Route B - Suburbs</span></p>
                    </div>
                    <div id="studentValidationList" class="space-y-2 mb-4">
                        <!-- Students dynamically loaded here -->
                        <div class="flex justify-between items-center p-2 bg-gray-50 rounded-md border border-gray-200">
                            <span>Alice Johnson</span>
                            <span class="text-green-600 font-medium">Boarded</span>
                        </div>
                        <div class="flex justify-between items-center p-2 bg-gray-50 rounded-md border border-gray-200">
                            <span>Bob Williams</span>
                            <span class="text-green-600 font-medium">Boarded</span>
                        </div>
                        <div class="flex justify-between items-center p-2 bg-red-50 rounded-md border border-red-200">
                            <span>Charlie Brown</span>
                            <span class="text-red-600 font-medium">Missing</span>
                        </div>
                    </div>
                    <button onclick="validateDeparture()" class="w-full bg-green-700 text-white py-3 px-4 rounded-md hover:bg-green-800 text-lg font-semibold">
                        Confirm All Students Present & Depart
                    </button>
                    <p id="validationStatus" class="mt-4 text-center text-lg font-medium"></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Driver Dashboard Functions
        function markStudentBoarded(studentName) {
            alert(`Manually marking ${studentName} as boarded. This would update the student's status in the system.`);
            // In a real application, send an AJAX request to your backend
            // and then remove the specific alert div from the DOM or update its status.
        }

        document.getElementById('messageAudience').addEventListener('change', function() {
            const specificParentContactDiv = document.getElementById('specificParentContact');
            if (this.value === 'specific_parent') {
                specificParentContactDiv.classList.remove('hidden');
                document.getElementById('parentContact').setAttribute('required', 'true');
            } else {
                specificParentContactDiv.classList.add('hidden');
                document.getElementById('parentContact').removeAttribute('required');
            }
        });

        function sendBusChangeMessage(event) {
            event.preventDefault();
            const audience = document.getElementById('messageAudience').value;
            const parentContact = document.getElementById('parentContact').value;
            const subject = document.getElementById('busChangeSubject').value;
            const message = document.getElementById('busChangeMessage').value;

            let recipientInfo = '';
            if (audience === 'all_parents') {
                recipientInfo = 'All Parents on My Route';
            } else if (audience === 'school_admin') {
                recipientInfo = 'School Administration';
            } else if (audience === 'specific_parent') {
                recipientInfo = `Specific Parent: ${parentContact}`;
            }

            alert(`Message Sent!\nTo: ${recipientInfo}\nSubject: ${subject}\nMessage: ${message}\n\nThis would trigger an SMS/Email notification.`);
            
            // Clear form
            document.getElementById('busChangeSubject').value = '';
            document.getElementById('busChangeMessage').value = '';
            document.getElementById('messageAudience').value = 'all_parents';
            document.getElementById('specificParentContact').classList.add('hidden');
            document.getElementById('parentContact').value = '';
        }

        function validateDeparture() {
            const validationList = document.getElementById('studentValidationList');
            const missingStudents = validationList.querySelectorAll('.text-red-600').length;
            const validationStatus = document.getElementById('validationStatus');

            if (missingStudents > 0) {
                validationStatus.className = 'mt-4 text-center text-lg font-medium text-red-700';
                validationStatus.textContent = `üö® WARNING: ${missingStudents} student(s) are marked as missing. Cannot depart!`;
                alert(`Cannot depart! ${missingStudents} student(s) are marked as missing. Please resolve before leaving campus.`);
            } else {
                validationStatus.className = 'mt-4 text-center text-lg font-medium text-green-700';
                validationStatus.textContent = '‚úÖ All students accounted for. You may depart.';
                alert('All students accounted for. Bus is cleared for departure from campus.');
                // In a real system, this would trigger a status update for the bus and route.
            }
        }

        // Function to simulate loading students for validation (from backend)
        function loadStudentsForValidation() {
            const studentData = [
                { name: 'Alice Johnson', status: 'Boarded' },
                { name: 'Bob Williams', status: 'Boarded' },
                { name: 'Charlie Brown', status: 'Missing' }, // Example of a missing student
                { name: 'Diana Prince', status: 'Boarded' }
            ];

            const validationList = document.getElementById('studentValidationList');
            validationList.innerHTML = ''; // Clear existing list

            studentData.forEach(student => {
                const studentDiv = document.createElement('div');
                const statusClass = student.status === 'Missing' ? 'bg-red-50 border border-red-200' : 'bg-gray-50 border border-gray-200';
                const statusTextColor = student.status === 'Missing' ? 'text-red-600' : 'text-green-600';

                studentDiv.className = `flex justify-between items-center p-2 rounded-md ${statusClass}`;
                studentDiv.innerHTML = `
                    <span>${student.name}</span>
                    <span class="${statusTextColor} font-medium">${student.status}</span>
                `;
                validationList.appendChild(studentDiv);
            });
        }

        // Load students when the page loads (simulated)
        document.addEventListener('DOMContentLoaded', loadStudentsForValidation);

        // Example of adding a dynamic unboarded alert (can be triggered by backend data)
        function addUnboardedStudentAlert(name, stop, reason) {
            const alertsContainer = document.getElementById('unboardedStudentAlerts');
            const newAlert = document.createElement('div');
            newAlert.className = 'p-4 bg-yellow-50 border border-yellow-200 rounded-lg';
            newAlert.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <h4 class="font-medium text-yellow-800">Student Not Boarded: ${name}</h4>
                    <span class="text-xs text-yellow-600">${stop}</span>
                </div>
                <p class="text-sm text-yellow-700">${reason}</p>
                <p class="text-xs text-gray-600">Action: Check surroundings, contact school if necessary.</p>
                <button onclick="markStudentBoarded('${name}')" class="mt-2 text-xs bg-yellow-600 text-white px-3 py-1 rounded hover:bg-yellow-700">Mark Boarded (Manual)</button>
            `;
            alertsContainer.prepend(newAlert); // Add to the top
        }

        // You could call addUnboardedStudentAlert() based on real-time data from your backend.
        // For demonstration, let's add one after a short delay:
        // setTimeout(() => {
        //     addUnboardedStudentAlert('Frank Green', 'Stop 1 - Route B', 'Expected at 7:55 AM. No scan.');
        // }, 5000);

    </script>
</body>
</html>
