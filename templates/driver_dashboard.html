{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="csrf-token" content="{{ csrf_token }}" />
    <title>Driver Dashboard - BusTracker Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="{% static 'common_scripts.js' %}"></script>
    <script>
    function logout() {
        localStorage.removeItem('currentUserRole'); // Clear stored role
        window.location.href = '{% url "driver:logout" %}'; // Redirect to login page
    }
    </script>
</head>
<body class="bg-gradient-to-br from-green-50 to-teal-100 min-h-screen">

    <script>loadDashboardNav();</script>
    <nav class="bg-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-4">
                    <div class="text-2xl font-bold text-indigo-600">üöå BusTracker Pro</div>
                </div>
                    <div class="flex space-x-4">
                        <button onclick="window.location.href='{% url 'student:login_dashboard' %}'" class="px-4 py-2 text-gray-600 hover:text-indigo-600 transition-colors">Home</button>
                        <button onclick="window.location.href='{% url 'driver:generate_qr_code' bus.id %}'" class="px-4 py-2 text-blue-600 hover:text-blue-700 transition-colors">Generate QR Code</button>
                        <button id="logoutBtn" onclick="logout()" class="px-4 py-2 text-red-600 hover:text-red-700 transition-colors">Logout</button>
                    </div>
            </div>
        </div>
    </nav>
    <div id="driver-dashboard-section" class="section active">
        <div class="max-w-7xl mx-auto py-8 px-4">
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h1 class="text-3xl font-bold text-gray-900 mb-2">Driver Dashboard</h1>
                <p class="text-gray-600">Manage student boarding, bus communications, and campus departure validation</p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <!-- Unboarded Student Alerts -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-xl font-semibold mb-4">‚ö†Ô∏è Unboarded Student Alerts</h3>
                    <div id="unboardedStudentAlerts" class="space-y-4">
                        {% for alert in alerts %}
                        <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                            <div class="flex justify-between items-start mb-2">
                                <h4 class="font-medium text-yellow-800">Student Not Boarded: {{ alert.student.name }}</h4>
                                <span class="text-xs text-yellow-600">{{ alert.student.pickup_point }}</span>
                            </div>
                            <p class="text-sm text-yellow-700">Expected to board. Not scanned for {{ alert.display_type }} session.</p>
                            <p class="text-xs text-gray-600">Action: Check surroundings, contact school if necessary.</p>
                            <button onclick="markStudentBoarded({{ alert.student.id }})" class="mt-2 text-xs bg-yellow-600 text-white px-3 py-1 rounded hover:bg-yellow-700">Mark Boarded (Manual)</button>
                        </div>
                        {% empty %}
                        <p>No unboarded students.</p>
                        {% endfor %}
                    </div>
                </div>

                <!-- Send Message about Bus Change -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-xl font-semibold mb-4">üì¢ Send Bus Change Message</h3>
                    <form onsubmit="sendBusChangeMessage(event)" class="space-y-4">
                        <div>
                            <label for="messageAudience" class="block text-sm font-medium mb-2">Send To</label>
                            <select id="messageAudience" class="w-full p-2 border rounded-md">
                                <option value="all_parents">All Parents on My Route</option>
                                <option value="school_admin">School Administration</option>
                                <option value="specific_parent">Specific Parent (Enter Email/Phone)</option>
                            </select>
                        </div>
                        <div id="specificParentContact" class="hidden">
                            <label for="parentContact" class="block text-sm font-medium mb-2">Parent Email/Phone</label>
                            <input type="text" id="parentContact" class="w-full p-2 border rounded-md" placeholder="e.g., parent@email.com or 123-456-7890">
                        </div>
                        <div>
                            <label for="busChangeSubject" class="block text-sm font-medium mb-2">Subject</label>
                            <input type="text" id="busChangeSubject" required class="w-full p-2 border rounded-md" placeholder="e.g., Bus Delay, Route Change">
                        </div>
                        <div>
                            <label for="busChangeMessage" class="block text-sm font-medium mb-2">Message</label>
                            <textarea id="busChangeMessage" rows="4" required class="w-full p-2 border rounded-md" placeholder="e.g., Bus #7 is delayed by 15 minutes due to traffic."></textarea>
                        </div>
                        <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">
                            Send Message
                        </button>
                    </form>
                </div>

                <!-- Validate Students Before Departure -->
                <div class="bg-white rounded-lg shadow-lg p-6 col-span-1 lg:col-span-2">
                    <h3 class="text-xl font-semibold mb-4">‚úÖ Validate Students Before Campus Departure</h3>
                    <div class="mb-4">
                        <p class="text-gray-700">Current Bus: <span id="currentBusNumber" class="font-semibold">{{ bus.bus_no }}</span></p>
                        <p class="text-gray-700">Route: <span id="currentBusRoute" class="font-semibold">{{ bus.bus_starting_point }}</span></p>
                    </div>
                    <div id="studentValidationList" class="space-y-2 mb-4">
                        {% for student in students %}
                        <div class="flex justify-between items-center p-2 {% if student.status == 'not_boarded' %}bg-red-50 border border-red-200{% else %}bg-gray-50 border border-gray-200{% endif %} rounded-md">
                    <div>
                        <span>{{ student.student.name }}</span>
                        {% if student.morning_scan %}
                        <br><span class="text-sm text-green-600">Boarded Morning</span>
                        {% else %}
                        <br><span class="text-sm text-red-600">Not Boarded Morning</span>
                        {% endif %}
                        {% if student.morning_latitude and student.morning_longitude %}
                        <br><span class="text-xs text-gray-600">Location: {{ student.morning_latitude }}, {{ student.morning_longitude }}</span>
                        {% endif %}
                        {% if student.evening_scan %}
                        <br><span class="text-sm text-green-600">Boarded Evening</span>
                        {% else %}
                        <br><span class="text-sm text-red-600">Not Boarded Evening</span>
                        {% endif %}
                        {% if student.evening_latitude and student.evening_longitude %}
                        <br><span class="text-xs text-gray-600">Location: {{ student.evening_latitude }}, {{ student.evening_longitude }}</span>
                        {% endif %}
                    </div>
                    <span class="{% if student.status == 'not_boarded' %}text-red-600{% else %}text-green-600{% endif %} font-medium">{{ student.status|title }}</span>
                </div>
                {% endfor %}
                {% if hostelers %}
                <div class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <h4 class="font-semibold text-blue-700 mb-2">Hosteler Students to Pickup/Drop</h4>
                    <ul class="list-disc list-inside text-blue-700">
                        {% for hosteler in hostelers %}
                        <li>{{ hosteler.student_id.name }} - Pickup Point: {{ hosteler.pickup_point }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
                    </div>
                    <button onclick="validateDeparture()" class="w-full bg-green-700 text-white py-3 px-4 rounded-md hover:bg-green-800 text-lg font-semibold">
                        Confirm All Students Present & Depart
                    </button>
                    <p id="validationStatus" class="mt-4 text-center text-lg font-medium"></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const csrfToken = document.querySelector('meta[name="csrf-token"]').content;

        // Driver Dashboard Functions
        function markStudentBoarded(studentId) {
            // Get current location
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    const latitude = position.coords.latitude;
                    const longitude = position.coords.longitude;
                    sendMarkBoardedRequest(studentId, latitude, longitude);
                }, function(error) {
                    console.error('Error getting location:', error);
                    alert('Error getting location. Please enable location services.');
                });
            } else {
                alert('Geolocation is not supported by this browser.');
            }
        }

        function sendMarkBoardedRequest(studentId, latitude, longitude) {
            var url = "{% url 'driver:mark_student_boarded' 0 %}".replace('0', studentId);
            fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    'latitude': latitude,
                    'longitude': longitude
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('Student marked as boarded.');
                    location.reload();
                } else {
                    alert('Error: ' + data.message);
                }
            });
        }

        document.getElementById('messageAudience').addEventListener('change', function() {
            const specificParentContactDiv = document.getElementById('specificParentContact');
            if (this.value === 'specific_parent') {
                specificParentContactDiv.classList.remove('hidden');
                document.getElementById('parentContact').setAttribute('required', 'true');
            } else {
                specificParentContactDiv.classList.add('hidden');
                document.getElementById('parentContact').removeAttribute('required');
            }
        });

        function sendBusChangeMessage(event) {
            event.preventDefault();
            const audience = document.getElementById('messageAudience').value;
            const parentContact = document.getElementById('parentContact').value;
            const subject = document.getElementById('busChangeSubject').value;
            const message = document.getElementById('busChangeMessage').value;

            var url = "{% url 'driver:send_bus_change_message' %}";
            fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    'audience': audience,
                    'parent_contact': parentContact,
                    'subject': subject,
                    'message': message,
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('Message sent successfully.');
                    // Clear form
                    document.getElementById('busChangeSubject').value = '';
                    document.getElementById('busChangeMessage').value = '';
                    document.getElementById('messageAudience').value = 'all_parents';
                    document.getElementById('specificParentContact').classList.add('hidden');
                    document.getElementById('parentContact').value = '';
                } else {
                    alert('Error sending message.');
                }
            });
        }

        function validateDeparture() {
            fetch('{% url "driver:validate_departure" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('All students accounted for. You may depart.');
                    location.reload();
                } else {
                    alert(data.message);
                }
            });
        }
    </script>
</body>
</html>
